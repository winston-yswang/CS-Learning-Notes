## 传输层基础

> 传输层的功能

- 传输层提供进程和进程之间的逻辑通信
- 复用和分用
- 传输层对收到的报文进行差错检测

> 传输层的寻址与端口

复用：应用层所有的应用进程都可以通过传输层再传输到网络层

分用：传输层从网络层收到数据后交付指明的应用进程

端口号：长度为16bit，能表示65536个不同的端口号

### UDP协议

UDP（User Datagram Protocol）只在IP数据报服务上增加了很少功能，即复用分用和差错检测功能。

UDP的主要特点：

1. UDP是无连接的，减少开销和发送数据之前的时延
2. UDP使用最大努力交付，即不保证可靠交付
3. UDP是面向报文的，应用层给UDP多长的报文，UDP就照样发送，即一次法一个完整报文，适合一次性传输少量数据的网络应用
4. UDP无拥塞控制，适合很多实时应用
5. UDP首部开销小，8B，TCP20B

> UDP首部格式

![image-20211123194559470](pics\image-20211123194559470.png)

- 16位UDP长度：UDP用户数据报的整个长度；
- 16位UDP检验和：检测整个UDP数据报是否有错，错就丢弃；
- 分用时，找不到对应的目的端口号，就丢弃报文，并给发送方发送ICMP”端口不可达“差错报告报文。



### TCP协议

> TCP协议（Transmission Control Protocol）的特点

1. TCP是面向连接（虚连接）的传输层协议
2. 每一个TCP连接只能有两个端点，每一条TCP连接只能是点对点的
3. TCP提供可靠交付的服务，无差错、不丢失、不重复、按序到达（可靠有序，不丢不重）
4. TCP提供全双工通信
   - 发送缓存：准备发送的数据&已发送但尚未收到确认的数据
   - 接收缓存：按序到达但尚未被接受应用程序读取的数据&不按序到达的数据
5. 面向字节流：TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流

> TCP报文段首部格式

![image-20211124095240830](pics\image-20211124095240830.png)

- 源端口、目的端口：各自占16bit
- 序号：在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发数据的第一个字节的序号
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N，则证明到序号N-1为止的所有数据都已正确收到
- 数据偏移：首部长度，TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B为单位，即1个数值是4B
- 6个控制位
  - 紧急位URG：URG=1时，标明此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队，配合紧急指针字段使用；
  - 确认位ACK：ACK=1时确认号有效，在连接建立后所有传送的报文段都必须把ACK置为1；
  - 推送位PSH：PSH=1时，接收方尽快交付接收应用进程，不再等到缓存填满再向上交付；
  - 复位RST：RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立传输链接；
  - 同步位SYN：SYN=1时，表明是一个连接请求/连接接受报文；
  - 终止位FIN：FIN=1时，表明此报文段发送方数据已发完，要求释放连接。

- 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量
- 校验和：检验首部+数据，检验时要加上12B伪首部，第四个字段为6
- 紧急指针：URG=1时才有意义，指出本报文段中紧急数据的字节数
- 选项：最大报文段长度MSS、窗口扩大、时间戳、选择确认...

> TCP的连接建立

![image-20211124104809161](pics\image-20211124104809161.png)

1. 客户端发送连接请求报文段，无应用层数据；

   SYN=1，seq=x（随机）

2. 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据；

   SYN=1， ACK=1，seq=y（随机），ack=x+1

3. 客户端为该TCP连接分配缓存和变量，并向服务器端返回确认的确认，可以携带数据

   SYN=0，ACK=1，seq=x+1，ack=y+1



> TCP的连接释放

![image-20211124111126873](pics\image-20211124111126873.png)

1. 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接；

   FIN=1，seq=u

2. 服务器回送一个确认报文段，客户到服务器这个方向的连接就释放了——半关闭状态；

   ACK=1，seq=v，ack=u+1

3. 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接；

   FIN=1，ACK=1，seq=w，ack=u+1

4. 客户端回送一个确认报文段，再等到时间等待计时器设置的2MSL（最长报文端寿命）后，连接彻底关闭

   ACK=1，seq=u+1，ack=w+1



> TCP的可靠传输

传输层：使用TCP实现可靠传输

网络层：提供尽最大努力交付，不可靠传输

可靠：保证接收方进程从缓存区读出的字节流与发送方发出的字节流是完全一样的。

TCP实现可靠传输的机制：

1. 校验：与UDP校验一样，增加伪首部
2. 序号：报文段首部确认字段
3. 确认：TCP默认使用累计确认
4. 重传：TCP的发送方在规定的时间内没有收到确认就要重传已发送的报文段。TCP采用自适应算法，动态改变重传时间RTTs（加权平均往返时间）

冗余ACK（冗余确认）：每当比期望序号大的失序报文段到达时，发送一个冗余ACK，指明下一个期待字节的序号。

> TCP流量控制

TCP利用滑动窗口机制实现流量控制：

在通信过程中，接收方根据字节接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd（接收方设置确认报文段的窗口字段来将rwnd通知给发送方），发送方的发送窗口区接收窗口rwnd和拥塞窗口cwnd的最小值。

![image-20211124140839154](pics\image-20211124140839154.png)



> TCP拥塞控制

出现拥塞的条件：

对资源需求的总和 > 可用资源

网络中许多资源同时呈现供应不足 -> 网络性能变坏 -> 网络吞吐量将随输入负荷增大而下降

拥塞控制：防止过多的数据注入网络中

接收窗口：接收方根据接收缓存设置的值，并告知发送方，反映接收方容量

拥塞窗口：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量

**拥塞控制四种算法**

慢开始、拥塞避免、快重传、快恢复

假定：

1. 数据单方向传送，而另一个方向只传送确认
2. 接收方总是有足够大的缓存空间，因而发送窗口大小取决于拥塞程度，即发送窗口=Min{接收窗口rwnd，拥塞窗口cwnd}

- 慢开始和拥塞控制

![image-20211124142505151](pics\image-20211124142505151.png)

- 快重传和快恢复

![image-20211124142858173](pics\image-20211124142858173.png)

