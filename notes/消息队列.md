## 一、消息队列基础

### 1、使用消息队列的理由

原本业务体量很小，所以直接**单机一把梭**啥都能搞定了，但是后面业务体量不断扩大，采用**微服务的设计思想**，**分布式的部署方式**，所以拆分了很多的服务，随着体量的增加以及业务场景越来越复杂了，很多场景单机的技术栈和中间件以及不够用了，而且对系统的友好性也下降了，最后做了很多技术选型的工作，我们决定引入**消息队列中间件**。

### 2、消息队列的使用场景

异步、解耦、削峰

### 3、消息队列存在的问题

#### 系统复杂性

存在着**消息重复消费、消息丢失、消息的顺序消费**等问题

#### 数据一致性

分布式服务都存在的一个问题：如何确保所有关联的服务全成功

#### 可用性

一旦MQ挂了，关联服务都会受到影响。

### 4、消息重复消费

真实的情况其实重试是很正常的，服务的**网络抖动**，**开发人员代码Bug**，还有**数据问题**等都可能处理失败要求重发的。

开发过程中保证数据的一致性，一般会做接口**幂等**。

> **幂等（idempotent、idempotence）**是一个数学与计算机学概念，常见于抽象代数中。
>
> 在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。
>
> 幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。
>
> 例如，“setTrue()”函数就是一个幂等函数,**无论多次执行，其结果都是一样的.**更复杂的操作幂等保证是利用唯一交易号(流水号)实现.

通俗了讲就是你**同样的参数调用我这个接口，调用多少次结果都是一个**。

一般**幂等**，我会**分场景去考虑**，看是**强校验**还是**弱校验**，比如跟金钱相关的场景那就很关键呀，就做强校验，别不是很重要的场景做弱校验。

### 5、分布式事务

分布式事务：**一系列不同的服务要么大家都成功，要么大家都失败**











参考文章：

https://mp.weixin.qq.com/s/OKon95MRUqDc9IwtEqPSjQ