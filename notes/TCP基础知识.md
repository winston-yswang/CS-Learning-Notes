### 1、TCP和UDP的特点

- 用户数据报协议 UDP（User Datagram Protocol）是面向无连接的数据报协议，使用尽最大可能交付，无拥塞控制、首部开销小。

- 传输控制协议 TCP（Transmission Control Protocol）是面向连接的，可靠的流协议，且提供顺序控制、流量控制、拥塞控制、全双工端到端通信等功能。

显然，TCP主要用于在传输层有必要实现可靠传输的情况，而UDP适用于那些对高速传输和实时性有较高要求的通信或者广播通信。

> ps：可靠是指无差错、不丢失、不重复、按序到达；流是指把数据看成仅仅是一连串的无结构的字节流



### 2、UDP首部格式

![UDP格式](pics\UDP格式.jpg)

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。



### 3、TCP首部格式

![TCP格式](pics\TCP格式.png)

- 源端口、目的端口：各自占16bit
- 序号：在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发数据的第一个字节的序号
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N，则证明到序号N-1为止的所有数据都已正确收到
- 数据偏移：首部长度，TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B为单位，即1个数值是4B
- 6个控制位
  - 紧急位URG：URG=1时，标明此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队，配合紧急指针字段使用；
  - 确认位ACK：ACK=1时确认号有效，在连接建立后所有传送的报文段都必须把ACK置为1；
  - 推送位PSH：PSH=1时，接收方尽快交付接收应用进程，不再等到缓存填满再向上交付；
  - 复位RST：RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立传输链接；
  - 同步位SYN：SYN=1时，表明是一个连接请求/连接接受报文；
  - 终止位FIN：FIN=1时，表明此报文段发送方数据已发完，要求释放连接。

- 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量
- 校验和：检验首部+数据，检验时要加上12B伪首部，第四个字段为6
- 紧急指针：URG=1时才有意义，指出本报文段中紧急数据的字节数
- 选项：最大报文段长度MSS、窗口扩大、时间戳、选择确认...



### 4、TCP三次握手

![TCP三次握手](pics\TCP三次握手.png)

1. 客户端发送连接请求报文段，无应用层数据；

   SYN=1，seq=x（随机）

2. 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据；

   SYN=1， ACK=1，seq=y（随机），ack=x+1

3. 客户端为该TCP连接分配缓存和变量，并向服务器端返回确认的确认，可以携带数据

   SYN=0，ACK=1，seq=x+1，ack=y+1



### 5、TCP四次挥手

![TCP四次挥手](pics\TCP四次挥手.jpg)

1. 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接；

   FIN=1，seq=u

2. 服务器回送一个确认报文段，客户到服务器这个方向的连接就释放了——半关闭状态；

   ACK=1，seq=v，ack=u+1

3. 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接；

   FIN=1，ACK=1，seq=w，ack=u+1

4. 客户端回送一个确认报文段，再等到时间等待计时器设置的2MSL（最长报文端寿命）后，连接彻底关闭

   ACK=1，seq=u+1，ack=w+1



### 6、TCP可靠传输

为了通过IP数据报实现可靠性传输，需要考虑很多问题，例如数据的破坏、丢包、重复以及分片顺序混乱等问题。

TCP通过检验和、序列号、ARQ协议、超时重传、连接管理以及窗口控制等机制实现可靠性传输。



### 7、ARQ 协议

**自动重传请求**（Automatic Repeat-reQuest，ARQ）是 OSI 模型中数据链路层和传输层的错误纠正协议之一。它通过使用确认和超时这两个机制，在不可靠服务的基础上实现可靠的信息传输。如果发送方在发送后一段时间之内没有收到确认帧，它通常会重新发送。ARQ 包括停止等待 ARQ 协议和连续 ARQ 协议。

#### 停止等待 ARQ 协议

停止等待协议是为了实现可靠传输的，它的基本原理就是每发完一个分组就停止发送，等待对方确认（回复 ACK）。如果过了一段时间（超时时间后），还是没有收到 ACK 确认，说明没有发送成功，需要重新发送，直到收到确认后再发下一个分组。

在停止等待协议中，若接收方收到重复分组，就丢弃该分组，但同时还要发送确认。

**优缺点：**

- **优点：** 简单
- **缺点：** 信道利用率低，等待时间长

**1) 无差错情况:**

发送方发送分组,接收方在规定时间内收到,并且回复确认.发送方再次发送。

**2) 出现差错情况（超时重传）:**

停止等待协议中超时重传是指只要超过一段时间仍然没有收到确认，就重传前面发送过的分组（认为刚才发送过的分组丢失了）。因此每发送完一个分组需要设置一个超时计时器，其重传时间应比数据在分组传输的平均往返时间更长一些。这种自动重传方式常称为 **自动重传请求 ARQ** 。另外在停止等待协议中若收到重复分组，就丢弃该分组，但同时还要发送确认。**连续 ARQ 协议** 可提高信道利用率。发送维持一个发送窗口，凡位于发送窗口内的分组可连续发送出去，而不需要等待对方确认。接收方一般采用累积确认，对按序到达的最后一个分组发送确认，表明到这个分组位置的所有分组都已经正确收到了。

**3) 确认丢失和确认迟到**

- **确认丢失** ：确认消息在传输过程丢失。当 A 发送 M1 消息，B 收到后，B 向 A 发送了一个 M1 确认消息，但却在传输过程中丢失。而 A 并不知道，在超时计时过后，A 重传 M1 消息，B 再次收到该消息后采取以下两点措施：1. 丢弃这个重复的 M1 消息，不向上层交付。 2. 向 A 发送确认消息。（不会认为已经发送过了，就不再发送。A 能重传，就证明 B 的确认消息丢失）。
- **确认迟到** ：确认消息在传输过程中迟到。A 发送 M1 消息，B 收到并发送确认。在超时时间内没有收到确认消息，A 重传 M1 消息，B 仍然收到并继续发送确认消息（B 收到了 2 份 M1）。此时 A 收到了 B 第二次发送的确认消息。接着发送其他数据。过了一会，A 收到了 B 第一次发送的对 M1 的确认消息（A 也收到了 2 份确认消息）。处理如下：1. A 收到重复的确认后，直接丢弃。2. B 收到重复的 M1 后，也直接丢弃重复的 M1。

#### 连续 ARQ 协议

连续 ARQ 协议可提高信道利用率。发送方维持一个发送窗口，凡位于发送窗口内的分组可以连续发送出去，而不需要等待对方确认。接收方一般采用累计确认，对按序到达的最后一个分组发送确认，表明到这个分组为止的所有分组都已经正确收到了。

**优缺点：**

- **优点：** 信道利用率高，容易实现，即使确认丢失，也不必重传。
- **缺点：** 不能向发送方反映出接收方已经正确收到的所有分组的信息。 比如：发送方发送了 5 条 消息，中间第三条丢失（3 号），这时接收方只能对前两个发送确认。发送方无法知道后三个分组的下落，而只好把后三个全部重传一次。这也叫 Go-Back-N（回退 N），表示需要退回来重传已经发送过的 N 个消息。



### 8、流量控制

**TCP 利用滑动窗口实现流量控制。流量控制是为了控制发送方发送速率，保证接收方来得及接收。** 

窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。



### 9、拥塞控制

网络拥塞出现多是资源的需求总和大于可用资源，网络供应能力不足，使得网络性能变坏，网络吞吐量将随输入负荷增大而下降，所以拥塞控制就是为防止过多的数据注入网络中。

先明确两个概念：

- 接收窗口：接收方根据接收缓存设置的值，并告知发送方，反映接收方容量


- 拥塞窗口：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量

接着依次介绍拥塞控制的四种算法：慢开始、拥塞避免、快重传、快恢复。

为了便于讨论，做如下假设：

- 接收方有足够大的接收缓存，因此不会发生流量控制；
- 虽然 TCP 的窗口基于字节，但是这里设窗口的大小单位为报文段。

![拥塞控制-慢开始](pics\拥塞控制-慢开始.png)

#### 慢开始与拥塞避免

- **慢开始：** 慢开始算法的思路是当主机开始发送数据时，如果立即把大量数据字节注入到网络，那么可能会引起网络阻塞，因为现在还不知道网络的符合情况。经验表明，较好的方法是先探测一下，即由小到大逐渐增大发送窗口，也就是由小到大逐渐增大拥塞窗口数值。cwnd 初始值为 1，每经过一个传播轮次，cwnd 加倍。设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh，则进入拥塞避免。

- **拥塞避免：** 拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢增大，即每经过一个往返时间 RTT 就把发送放的 cwnd 加 1。

  如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。

![拥塞控制-快重传](pics\拥塞控制-快重传.png)

#### 快重传与快恢复


在 TCP/IP 中，快速重传和恢复（fast retransmit and recovery，FRR）是一种拥塞控制算法，它能快速恢复丢失的数据包。

- 在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。

- 在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。
- 在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。

补充点：

1. 慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。
2. 没有 FRR，如果数据包丢失了，TCP 将会使用定时器来要求传输暂停。在暂停的这段时间内，没有新的或复制的数据包被发送。有了 FRR，如果接收机接收到一个不按顺序的数据段，它会立即给发送机发送一个重复确认。如果发送机接收到三个重复确认，它会假定确认件指出的数据段丢失了，并立即重传这些丢失的数据段。有了 FRR，就不会因为重传时要求的暂停被耽误。当有单独的数据包丢失时，快速重传和恢复（FRR）能最有效地工作。当有多个数据信息包在某一段很短的时间内丢失时，它则不能很有效地工作。

